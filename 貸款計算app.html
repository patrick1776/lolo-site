<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業銀行貸款還款試算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body class="bg-gray-50 p-4 md:p-10">
    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="bg-slate-800 text-white p-6">
            <h1 class="text-2xl font-bold text-center">銀行貸款還款年度試算 APP</h1>
        </div>
        
        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4 border-r pr-0 md:pr-6 border-gray-200">
                <div>
                    <label class="block text-sm font-medium text-gray-700">貸款總額 (TWD)</label>
                    <input type="number" id="loanAmount" value="1000000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">年利率 (%)</label>
                    <input type="number" id="annualRate" value="2.1" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">貸款年限 (年)</label>
                    <input type="number" id="loanYears" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">還款方式</label>
                    <select id="method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                        <option value="fixedTotal">本息平均攤還 (固定支付金額)</option>
                        <option value="fixedPrincipal">本金平均攤還 (固定還本金)</option>
                    </select>
                </div>
                <div>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="useGrace" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-700">啟用寬限期</span>
                    </label>
                    <input type="number" id="graceMonths" placeholder="寬限月份 (例如 24)" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm border p-2 hidden">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">手續費/稅金 (TWD)</label>
                    <input type="number" id="fees" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                </div>
                <button onclick="calculate()" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">開始計算</button>
                <button onclick="exportExcel()" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition">下載含公式 Excel</button>
            </div>

            <div class="md:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">年度還款摘要表</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">年度</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">本金還款</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">利息支出</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">年度總付</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">剩餘本金</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('useGrace').addEventListener('change', function() {
            document.getElementById('graceMonths').classList.toggle('hidden', !this.checked);
        });

        let lastCalculationData = null;

        function calculate() {
            const amount = new Decimal(document.getElementById('loanAmount').value);
            const annualRate = new Decimal(document.getElementById('annualRate').value).div(100);
            const monthlyRate = annualRate.div(12);
            const totalMonths = parseInt(document.getElementById('loanYears').value) * 12;
            const method = document.getElementById('method').value;
            const useGrace = document.getElementById('useGrace').checked;
            const graceMonths = useGrace ? parseInt(document.getElementById('graceMonths').value || 0) : 0;
            const fees = new Decimal(document.getElementById('fees').value || 0);

            let schedule = [];
            let remainingBalance = amount;
            const repaymentMonths = totalMonths - graceMonths;

            for (let m = 1; m <= totalMonths; m++) {
                let interest = remainingBalance.mul(monthlyRate);
                let principal = new Decimal(0);

                if (m <= graceMonths) {
                    principal = new Decimal(0);
                } else {
                    if (method === 'fixedTotal') {
                        // 本息平均攤還公式: PMT = P * r * (1+r)^n / ((1+r)^n - 1)
                        let pmt = amount.mul(monthlyRate.mul(monthlyRate.add(1).pow(repaymentMonths)))
                                       .div(monthlyRate.add(1).pow(repaymentMonths).sub(1));
                        principal = pmt.sub(interest);
                    } else {
                        // 本金平均攤還
                        principal = amount.div(repaymentMonths);
                    }
                }

                if (m === totalMonths) principal = remainingBalance; // 最後一期調整

                remainingBalance = remainingBalance.sub(principal);
                schedule.push({ month: m, principal, interest, total: principal.add(interest), balance: remainingBalance });
            }

            renderTable(schedule);
            lastCalculationData = { amount, annualRate, totalMonths, graceMonths, method, schedule, fees };
        }

        function renderTable(schedule) {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            
            let yearlyData = [];
            for (let i = 0; i < schedule.length; i += 12) {
                let chunk = schedule.slice(i, i + 12);
                let year = Math.floor(i / 12) + 1;
                let yearPrincipal = chunk.reduce((sum, s) => sum.add(s.principal), new Decimal(0));
                let yearInterest = chunk.reduce((sum, s) => sum.add(s.interest), new Decimal(0));
                let lastBalance = chunk[chunk.length - 1].balance;

                yearlyData.push({ year, yearPrincipal, yearInterest, lastBalance });

                const row = `<tr>
                    <td class="px-4 py-2">第 ${year} 年</td>
                    <td class="px-4 py-2 text-blue-600">${yearPrincipal.toFixed(0)}</td>
                    <td class="px-4 py-2 text-red-600">${yearInterest.toFixed(0)}</td>
                    <td class="px-4 py-2 font-bold">${yearPrincipal.add(yearInterest).toFixed(0)}</td>
                    <td class="px-4 py-2 text-gray-500">${lastBalance.toFixed(0)}</td>
                </tr>`;
                tbody.innerHTML += row;
            }
        }

        async function exportExcel() {
            if (!lastCalculationData) { alert('請先點擊計算'); return; }
            
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet('還款明細');

            // 1. 設置參數區 (讓使用者知道公式來源)
            sheet.getCell('A1').value = '貸款參數';
            sheet.getCell('A2').value = '貸款金額'; sheet.getCell('B2').value = Number(lastCalculationData.amount);
            sheet.getCell('A3').value = '年利率'; sheet.getCell('B3').value = Number(lastCalculationData.annualRate);
            sheet.getCell('A4').value = '期數(月)'; sheet.getCell('B4').value = lastCalculationData.totalMonths;
            sheet.getCell('A5').value = '寬限期(月)'; sheet.getCell('B5').value = lastCalculationData.graceMonths;
            sheet.getCell('A6').value = '手續費'; sheet.getCell('B6').value = Number(lastCalculationData.fees);

            // 2. 設置表格標題
            const headerRow = sheet.getRow(8);
            headerRow.values = ['期數', '期初餘額', '本金還款', '利息支出', '本息合計', '期末餘額'];
            headerRow.font = { bold: true };

            // 3. 填充數據與公式 (範例：以本金平均攤還為例的公式嵌入)
            lastCalculationData.schedule.forEach((item, index) => {
                const rowNum = 9 + index;
                const row = sheet.getRow(rowNum);
                
                // 期數
                row.getCell(1).value = item.month;
                // 期初餘額 (引用上一期期末)
                if (index === 0) {
                    row.getCell(2).value = { formula: 'B2' };
                } else {
                    row.getCell(2).value = { formula: `F${rowNum - 1}` };
                }
                
                // 利息支出 = 期初餘額 * (年利率/12)
                row.getCell(4).value = { formula: `B${rowNum}*($B$3/12)` };
                
                // 本金還款 (動態根據 JS 計算結果，或在 Excel 中使用 IF 判斷寬限期)
                row.getCell(3).value = Number(item.principal.toFixed(2));
                
                // 本息合計
                row.getCell(5).value = { formula: `C${rowNum}+D${rowNum}` };
                // 期末餘額
                row.getCell(6).value = { formula: `B${rowNum}-C${rowNum}` };
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = 'Loan_Schedule_with_Formulas.xlsx';
            anchor.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>